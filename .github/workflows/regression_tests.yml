name: Regression and Safety Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC to catch issues early
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio pytest-mock requests-mock psutil jsonschema

    - name: Run smoke tests
      run: |
        pytest tests/test_integration_smoke.py -v --tb=short
      continue-on-error: true

    - name: Run schema compliance tests
      run: |
        pytest tests/test_schema_compliance.py -v --tb=short

    - name: Run security tests
      run: |
        pytest tests/test_security_safety.py -v --tb=short

  performance-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio pytest-mock psutil

    - name: Run performance baseline tests
      run: |
        pytest tests/test_performance_regression.py -v --tb=short -m "not slow"

    - name: Run sustained load tests
      run: |
        pytest tests/test_performance_regression.py -v --tb=short -m "slow"
      continue-on-error: true

  compatibility-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mcp-version: ['latest']  # Add specific versions as needed

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio pytest-mock

    - name: Test MCP compatibility
      run: |
        pytest tests/test_schema_compliance.py::TestMCPFrameworkCompatibility -v

  integration-tests:
    runs-on: ubuntu-latest
    services:
      # Could add real Swarm node here for full integration testing
      # swarm:
      #   image: ethersphere/bee:latest
      #   ports:
      #     - 1635:1635
      #   options: --health-cmd="curl -f http://localhost:1635/health" --health-interval=30s
      pass:
        image: hello-world  # Placeholder

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio pytest-mock requests-mock

    - name: Run integration tests (mocked)
      run: |
        pytest tests/test_integration_smoke.py -v -k "not test_gateway" --tb=short

    # Uncomment when real gateway integration is needed:
    # - name: Start gateway service
    #   run: |
    #     cd ../swarm_connect
    #     python -m pip install -r requirements.txt
    #     python run.py &
    #     sleep 10

    # - name: Run real integration tests
    #   run: |
    #     pytest tests/test_integration_smoke.py -v -m integration --tb=short
    #   env:
    #     SWARM_GATEWAY_URL: http://localhost:8000

  security-audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install safety bandit pytest

    - name: Run safety check
      run: |
        safety check || echo "Safety check completed with warnings"

    - name: Run bandit security linter
      run: |
        bandit -r swarm_provenance_mcp/ -f json -o bandit-report.json || true
        bandit -r swarm_provenance_mcp/ || echo "Bandit scan completed"

    - name: Run custom security tests
      run: |
        pytest tests/test_security_safety.py -v --tb=short

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json

  test-results:
    runs-on: ubuntu-latest
    needs: [smoke-tests, performance-tests, compatibility-tests, security-audit]
    if: always()
    steps:
    - name: Report test results
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Smoke tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibility tests: ${{ needs.compatibility-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY

    - name: Fail if critical tests failed
      if: needs.smoke-tests.result == 'failure' || needs.security-audit.result == 'failure'
      run: |
        echo "Critical tests failed - failing the workflow"
        exit 1